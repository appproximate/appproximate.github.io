<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>Yu Hao</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/theme/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/jquery@2.1.1/dist/jquery.min.js"></script>
    <!-- slicknav -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/slicknav@1.0.8/dist/slicknav.min.css">
    <script src="https://cdn.jsdelivr.net/npm/slicknav@1.0.8/dist/jquery.slicknav.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
    <script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.2/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.6.2/html5shiv.js"></script>
    <![endif]-->
<script>
	$(function(){
		$('#menu').slicknav({'label':''});
	});
</script>
<link rel="apple-touch-icon" sizes="180x180" href="/theme/apple-touch-icon.png">
<link rel="icon" type="image/png" href="/theme/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/theme/favicon-16x16.png" sizes="16x16">
<link rel="manifest" href="/theme/manifest.json">
<link rel="mask-icon" href="/theme/safari-pinned-tab.svg" color="#5bbad5">
<link rel="shortcut icon" href="/theme/favicon.ico">
<meta name="apple-mobile-web-app-title" content="North Shore">
<meta name="application-name" content="North Shore">
<meta name="msapplication-config" content="/theme/browserconfig.xml">
<meta name="theme-color" content="#ffffff">
  </head>

  <body>
    <div id="wrapper">

      <header>
	<nav class="byline"><ul id="menu">
            <li><a href="/"><i class="fa fa-user" aria-hidden="true"></i>HOME</a></li>
            <li><a href="/pages/research.html"><i class="fa fa-graduation-cap" aria-hidden="true"></i>Research</a></li>
            <li><a href="/pages/code.html"><i class="fa fa-code-fork" aria-hidden="true"></i>Code</a></li>
            <li><a href="/blog_index.html"><i class="fa fa-pencil" aria-hidden="true"></i>Posts</a></li>
        </ul></nav><!-- /#menu -->
        <div class="downloads">
          <a href="http://weibo.com/whimsicalyuhao" class="fa fa-weibo"></a>
          <a href="http://github.com/whimian" class="fa fa-github"></a>
          <a href="https://www.linkedin.com/in/hao-yu-79ab2658" class="fa fa-linkedin"></a>
          <a href="#" class="fa fa-Another social link"></a>
        </div>
  <hgroup>
    <h1>Windows 10 安装 OpenSSH</h1>
    <footer class="article-footer">
      <address class="vcard author">
        By         <a class="url fn" href="/author/yuhao.html">yuhao</a>
      </address>
      <abbr class="published" title="2017-11-23T09:00:00+08:00">
         on 23.11.2017
      </abbr>
    </footer><!-- /.post-info -->
  </hgroup>
  



  <!--  <html xmlns:wb="http://open.weibo.com/wb">
  <script src="http://tjs.sjs.sinajs.cn/open/api/js/wb.js" type="text/javascript" charset="utf-8"></script>
-->

  <!-- /.share.js -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/css/share.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script>


      </header>
<section id="content" class="body article">
  <div class="entry-content">
    <h1> 安装 Win32-OpenSSH</h1>
<ul>
<li> 下载最新的发布版本  <a href="https://github.com/PowerShell/Win32-OpenSSH/releases">https://github.com/PowerShell/Win32-OpenSSH/releases</a></li>
<li> 解压到 <code>C:\Program Files\OpenSSH</code></li>
<li> 可以将该目录加入 Path</li>
<li>
<p> 以管理员权限安装 <code>SSHD</code> 和 <code>ssh-agent</code> 服务 :</p>
<p><code>powershell.exe -ExecutionPolicy Bypass -File install-sshd.ps1</code></p>
</li>
<li>
<p> 生成 Server Keys 并且限制这些文件的访问权限 ， 以管理员权限运行 ：</p>
<p><code>.\ssh-keygen.exe -A
powershell.exe -ExecutionPolicy Bypass -File .\FixHostFilePermissions.ps1 -Confirm:$false</code></p>
</li>
<li>
<p> 在 Windows 防火墙中为 SSH 服务器开启一个 port：</p>
<ul>
<li> 可以执行如下命令 ：</li>
</ul>
<p><code>New-NetFirewallRule -Protocol TCP -LocalPort 22 -Direction Inbound -Action Allow -DisplayName SSH</code></p>
<ul>
<li> 或者直接在防火墙图形界面中增加一个 port 22 的规则 。</li>
<li> 开启服务 ：</li>
</ul>
<p><code>net start sshd</code></p>
<ul>
<li> 设置默认开启服务 </li>
</ul>
<p><code>Set-Service sshd -StartupType Automatic
Set-Service ssh-agent -StartupType Automatic</code></p>
</li>
<li>
<p> 设置默认 ssh Shell：
     在服务器端的 windows registry 中设置 ssh 的默认 shell，</p>
<p><code>Computer\HKEY_LOCAL_MACHINE\SOFTWARE\OpenSSH\DefaultShell</code></p>
<p><img alt="registry" src="/images/registry_for_ssh.png" style="width: 1049px; height: auto; max-width: 100%;"/></p>
</li>
</ul>
<h1> 设置使用 SSH 秘钥登陆 </h1>
<p> 安装后 ， 可以直接使用用户名和密码方式从 client 登陆到 host 上 ：</p>
<p><code>ssh user@host</code></p>
<p> 要使用密匙登陆需要采用以下步骤来设置 ：</p>
<h2> 在 client 端 ：</h2>
<ol>
<li>
<p> 生成 key pair （ 即 private client key  和  public client key）</p>
</li>
<li>
<p> 在 <code>$HOME</code> 中建立 <code>.ssh</code> 目录 </p>
<p><code>mkdir $HOME\.ssh
cd $HOME\.ssh</code></p>
</li>
<li>
<p> 生成 key pair</p>
<p><code>ssh-keygen -t rsa -f id_rsa</code></p>
</li>
</ol>
<p>id_rsa  为 key 文件名 ， 生成时会提示输入 passphrase 来保护 private key， 也可以为空 。</p>
<ol>
<li>
<p> 在 ssh-agent 上注册 private key</p>
</li>
<li>
<p> 运行源码中的 <code>FixUserFilePermissions.ps1</code> 来对进行权限设置 </p>
<p><code>FixUserFilePermissions.ps1</code></p>
</li>
<li>
<p> 开启 ssh-agent:</p>
<p><code>net start ssh-agent</code></p>
</li>
<li>
<p> 将 key 注册到 <code>ssh-agent</code></p>
<p><code>ssh-add id_rsa</code></p>
</li>
<li>
<p> 使用 private key 来登陆 host</p>
<p><code>ssh -i .\id_rsa user@host</code></p>
</li>
</ol>
<h2> 在服务器端 </h2>
<ol>
<li>
<p> 同样在服务器端的用户目录 <code>$HOME</code> 下建立 <code>.ssh\</code>， 并在其中建立 <code>authorized_keys</code> 文件 ：</p>
<p><code>touch .ssh\authorized_keys
mkdir .ssh\other_keys</code></p>
<p> 将之前客户端上生成的 public client key  即  <code>id_rsa.pub</code> 文件 ， 发送到 host 上的 <code>$HOME\.ssh\other_keys\</code> 文件夹下 ， 在服务器上 ， 将这个 <code>id_ras.pub</code> 内容写入 <code>authorized_keys</code> 文件中 。</p>
<p><code>cat .\other_keys\id_rsa.pub &gt; authorized_keys</code></p>
<p><em><code>authorized_keys</code> 文件的编码要为 UTF-8， 而非 windows 默认编码 </em></p>
</li>
<li>
<p> 设置 <code>authorized_keys</code> 的访问权限 </p>
<p><code>FixUserFilePermissions.ps1</code></p>
</li>
</ol>
  </div><!-- /.entry-content -->
  <div class="article-share-tags">
    <div class="end-article-tags">
    </div>
    <div class='article-share'>
      share -
      <!--        <a target="_blank" href="http://twitter.com/share?text=Windows 10 安装 OpenSSH&amp;url=/windows-10-an-zhuang-openssh.html"><i class='fa fa-twitter'></i></a>
        <a target="_blank" href="http://facebook.com/sharer.php?t=Windows 10 安装 OpenSSH&amp;u=/windows-10-an-zhuang-openssh.html"><i class='fa fa-facebook'></i></a>
-->
      <!--      <wb:share-button appkey=appproximate000001 addition="number" type="button"></wb:share-button>
-->
      <div class="social-share"></div>
    </div>
  </div>
</section>
<div class="neighbors">
</div>
      <footer>
	  <a href="/pages/about.html" >About</a>
	  <div class="right-footer">
	  <a href="/categories.html" >Categories</a>
	  <a href="/tags.html" >Tags</a>
	  </div>
      </footer>
</body>
</html>